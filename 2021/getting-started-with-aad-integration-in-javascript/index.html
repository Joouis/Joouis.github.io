<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/hacker.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/hacker.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/hacker.ico">
  <link rel="mask-icon" href="/images/hacker.ico" color="#222">
  <meta name="google-site-verification" content="NbLkH228plarNfqTQkFa_uQ_H8j5Q3LNExDwLMXAxog">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"joouis.com","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.19.1","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="My sharing for the UX team about the auth process, components and some empirical knowledges from the business.">
<meta property="og:type" content="article">
<meta property="og:title" content="Getting started with AAD integration in JavaScript">
<meta property="og:url" content="https://joouis.com/2021/getting-started-with-aad-integration-in-javascript/index.html">
<meta property="og:site_name" content="江边的旱鸭子">
<meta property="og:description" content="My sharing for the UX team about the auth process, components and some empirical knowledges from the business.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6IHQAAAAAAJbw7JxUahyBCOI?width=1141&height=754">
<meta property="og:image" content="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6IXQAAAAAAPmBRQmNY7L1M_8?width=1820&height=1089">
<meta property="og:image" content="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6HXQAAAAAADtAdchzfpJcMlc?width=1928&height=1161">
<meta property="og:image" content="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6H3QAAAAAAEdVZ-zUMZ6cCHA?width=1319&height=863">
<meta property="og:image" content="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6HHQAAAAAAHpK1DZ6S5AguZg?width=1928&height=70">
<meta property="og:image" content="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6JHQAAAAAABGEAriQXq2iNsU?width=1181&height=227">
<meta property="og:image" content="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6InQAAAAAAOR5onzJTSk7gxw?width=1554&height=993">
<meta property="article:published_time" content="2021-04-14T00:05:13.000Z">
<meta property="article:modified_time" content="2021-09-16T09:52:00.000Z">
<meta property="article:author" content="John Chou">
<meta property="article:tag" content="TechTalk">
<meta property="article:tag" content="oauth">
<meta property="article:tag" content="azure">
<meta property="article:tag" content="aad">
<meta property="article:tag" content="auth">
<meta property="article:tag" content="msal">
<meta property="article:tag" content="microsoft-identity">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6IHQAAAAAAJbw7JxUahyBCOI?width=1141&height=754">


<link rel="canonical" href="https://joouis.com/2021/getting-started-with-aad-integration-in-javascript/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://joouis.com/2021/getting-started-with-aad-integration-in-javascript/","path":"2021/getting-started-with-aad-integration-in-javascript/","title":"Getting started with AAD integration in JavaScript"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Getting started with AAD integration in JavaScript | 江边的旱鸭子</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E247SGMNGH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-E247SGMNGH","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?199f195e233fd5ecca0d9346d3259670"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="江边的旱鸭子" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">江边的旱鸭子</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Blog of John Chou</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section">首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section">归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section">分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section">关于</a></li><li class="menu-item menu-item-recruit"><a href="/recruit/" rel="section">招聘</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger">搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Relationship-between-OAuth2-0-AAD-and-MSAL"><span class="nav-number">1.</span> <span class="nav-text">Relationship between OAuth2.0, AAD and MSAL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Definitions"><span class="nav-number">1.1.</span> <span class="nav-text">Definitions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OAuth-2-0"><span class="nav-number">1.1.1.</span> <span class="nav-text">OAuth 2.0</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Azure-Authentication-Directory"><span class="nav-number">1.1.2.</span> <span class="nav-text">Azure Authentication Directory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Microsoft-Authentication-Libraries"><span class="nav-number">1.1.3.</span> <span class="nav-text">Microsoft Authentication Libraries</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Usage-scenario"><span class="nav-number">1.2.</span> <span class="nav-text">Usage scenario</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Workflow-and-implementation"><span class="nav-number">2.</span> <span class="nav-text">Workflow and implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Authentication-flow"><span class="nav-number">2.1.</span> <span class="nav-text">Authentication flow</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Two-APIs"><span class="nav-number">2.1.1.</span> <span class="nav-text">Two APIs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Redirect-URI-setup"><span class="nav-number">2.1.2.</span> <span class="nav-text">Redirect URI setup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Configuration-on-Azure-Portal"><span class="nav-number">2.1.3.</span> <span class="nav-text">Configuration on Azure Portal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#oauth-html"><span class="nav-number">2.1.4.</span> <span class="nav-text">oauth.html</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-configuration"><span class="nav-number">2.1.5.</span> <span class="nav-text">Code configuration</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Authority"><span class="nav-number">2.1.6.</span> <span class="nav-text">Authority</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Scopes-and-permissions"><span class="nav-number">2.1.7.</span> <span class="nav-text">Scopes and permissions</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sign-in-with-redirect"><span class="nav-number">2.2.</span> <span class="nav-text">Sign-in with redirect</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Authorization-code"><span class="nav-number">2.2.1.</span> <span class="nav-text">Authorization code</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Acquire-a-token-with-a-redirect"><span class="nav-number">2.3.</span> <span class="nav-text">Acquire a token with a redirect</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Why-use-redirect-way"><span class="nav-number">2.3.1.</span> <span class="nav-text">Why use redirect way?</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Choice-of-MSAL-js"><span class="nav-number">2.4.</span> <span class="nav-text">Choice of MSAL.js</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Migration-from-AdalJS-to-MSAL-js"><span class="nav-number">3.</span> <span class="nav-text">Migration from AdalJS to MSAL.js</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Tips"><span class="nav-number">3.1.</span> <span class="nav-text">Tips</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Quick-login-verification-on-you-app-page"><span class="nav-number">3.2.</span> <span class="nav-text">Quick login verification on you app page</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#For-MSAL-js"><span class="nav-number">3.2.1.</span> <span class="nav-text">For MSAL.js</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#For-AdalJS"><span class="nav-number">3.2.2.</span> <span class="nav-text">For AdalJS</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frequently-asked-issues"><span class="nav-number">4.</span> <span class="nav-text">Frequently asked issues</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Debugging-and-verification-approach"><span class="nav-number">4.1.</span> <span class="nav-text">Debugging and verification approach</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Difference-between-access-token-ID-token-and-refresh-token"><span class="nav-number">4.2.</span> <span class="nav-text">Difference between access token, ID token, and refresh token</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-to-change-token-expiration-time"><span class="nav-number">4.3.</span> <span class="nav-text">How to change token expiration time?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InteractionRequiredAuthError-AADSTS50058-A-silent-sign-in-request-was-sent-but-no-user-is-signed-in"><span class="nav-number">4.4.</span> <span class="nav-text">InteractionRequiredAuthError: AADSTS50058: A silent sign-in request was sent but no user is signed in.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-frame-attempting-navigation-of-the-top-level-window-is-sandboxed-but-the-flag-of-%E2%80%98allow-top-navigation%E2%80%99-or-%E2%80%98allow-top-navigation-by-user-activation%E2%80%99-is-not-set"><span class="nav-number">4.5.</span> <span class="nav-text">The frame attempting navigation of the top-level window is sandboxed, but the flag of ‘allow-top-navigation’ or ‘allow-top-navigation-by-user-activation’ is not set.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BrowserAuthError-pcke-not-created-The-PCKE-code-challenge-and-verifier-could-not-be-generated"><span class="nav-number">4.6.</span> <span class="nav-text">BrowserAuthError: pcke_not_created: The PCKE code challenge and verifier could not be generated.</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">5.</span> <span class="nav-text">References</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="John Chou"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">John Chou</p>
  <div class="site-description" itemprop="description">Stand high, think different.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">265</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Joouis" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Joouis" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:luckyjoou@gmail.com" title="E-Mail → mailto:luckyjoou@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.instagram.com/Joouis" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;Joouis" rel="noopener me" target="_blank"><i class="fab fa-instagram fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="http://www.slideshare.net/choujohn351" title="SlideShare → http:&#x2F;&#x2F;www.slideshare.net&#x2F;choujohn351" rel="noopener me" target="_blank"><i class="fab fa-slideshare fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nd/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nd.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    相关文章
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2019/build-web-e2e-test-system-from-scratch/" rel="bookmark">
        <time class="popular-posts-time">2019-10-06</time>
        <br>
      Build web E2E test system from scratch
      </a>
    </li>
  </ul>

          </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://joouis.com/2021/getting-started-with-aad-integration-in-javascript/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="John Chou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江边的旱鸭子">
      <meta itemprop="description" content="Stand high, think different.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Getting started with AAD integration in JavaScript | 江边的旱鸭子">
      <meta itemprop="description" content="My sharing for the UX team about the auth process, components and some empirical knowledges from the business.">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Getting started with AAD integration in JavaScript
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-14 08:05:13" itemprop="dateCreated datePublished" datetime="2021-04-14T08:05:13+08:00">2021-04-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-09-16 17:52:00" itemprop="dateModified" datetime="2021-09-16T17:52:00+08:00">2021-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Web-%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">Web 前端</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2021/getting-started-with-aad-integration-in-javascript/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/getting-started-with-aad-integration-in-javascript/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

            <div class="post-description">My sharing for the UX team about the auth process, components and some empirical knowledges from the business.</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="Relationship-between-OAuth2-0-AAD-and-MSAL"><a href="#Relationship-between-OAuth2-0-AAD-and-MSAL" class="headerlink" title="Relationship between OAuth2.0, AAD and MSAL"></a>Relationship between OAuth2.0, AAD and MSAL</h2><h3 id="Definitions"><a href="#Definitions" class="headerlink" title="Definitions"></a>Definitions</h3><h4 id="OAuth-2-0"><a href="#OAuth-2-0" class="headerlink" title="OAuth 2.0"></a>OAuth 2.0</h4><p>OAuth 2.0 is the industry-standard <strong>protocol</strong> for authorization. OAuth 2.0 focuses on client developer simplicity while providing specific authorization flows for web applications, desktop applications, mobile phones, and living room devices.</p>
<h4 id="Azure-Authentication-Directory"><a href="#Azure-Authentication-Directory" class="headerlink" title="Azure Authentication Directory"></a>Azure Authentication Directory</h4><p>One of OAuth 2.0 and OpenID Connect standard-compliant authentication <strong>service</strong> enabling developers to authenticate work or school accounts. It’s the implementation which supports OAuth 2.0. It’s the component of Microsoft Identity platform.</p>
<h4 id="Microsoft-Authentication-Libraries"><a href="#Microsoft-Authentication-Libraries" class="headerlink" title="Microsoft Authentication Libraries"></a>Microsoft Authentication Libraries</h4><p>Open source <strong>libraries</strong> for <strong>several clients</strong> to authenticate users using AAD, Microsoft personal accounts (MSA), and social identity providers like Facebook, Google, LinkedIn, Microsoft accounts, etc.</p>
<h3 id="Usage-scenario"><a href="#Usage-scenario" class="headerlink" title="Usage scenario"></a>Usage scenario</h3><p><img data-src="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6IHQAAAAAAJbw7JxUahyBCOI?width=1141&height=754" alt="oauth-scenario"></p>
<h2 id="Workflow-and-implementation"><a href="#Workflow-and-implementation" class="headerlink" title="Workflow and implementation"></a>Workflow and implementation</h2><h3 id="Authentication-flow"><a href="#Authentication-flow" class="headerlink" title="Authentication flow"></a>Authentication flow</h3><p><img data-src="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6IXQAAAAAAPmBRQmNY7L1M_8?width=1820&height=1089" alt="auth-flow"></p>
<h4 id="Two-APIs"><a href="#Two-APIs" class="headerlink" title="Two APIs"></a>Two APIs</h4><p>Only two APIs requested from client-side, very simple. Notice that <code>/oauth2/v2.0/authorize</code> is <code>document</code> type.</p>
<p><img data-src="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6HXQAAAAAADtAdchzfpJcMlc?width=1928&height=1161" alt="auth-document"></p>
<h4 id="Redirect-URI-setup"><a href="#Redirect-URI-setup" class="headerlink" title="Redirect URI setup"></a>Redirect URI setup</h4><p>For CORS and redirect target from sign-in page usage, should configure it on both Azure Portal and codebase.</p>
<h4 id="Configuration-on-Azure-Portal"><a href="#Configuration-on-Azure-Portal" class="headerlink" title="Configuration on Azure Portal"></a>Configuration on Azure Portal</h4><p><img data-src="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6H3QAAAAAAEdVZ-zUMZ6cCHA?width=1319&height=863" alt="reply-uris-config"></p>
<h4 id="oauth-html"><a href="#oauth-html" class="headerlink" title="oauth.html"></a>oauth.html</h4><p>Usually we will set two reply URIs, one is probably the homepage as redirect target after signed in, another is used for requesting token silently. The silent token refresh loads an iframe using that empty <code>oauth.html</code> file, and that same <code>oauth.html</code> file needs to receive the response back, so the acquire token silent flow provides the <code>/oauth.html</code> endpoint as the redirect URI. This is different from the user-facing flow because there is no iframe that the middleware loads into the page, redirecting back to <code>oauth.html</code> will not hook into React or MSAL and auth would halt – it must redirect back to your react app in the user-facing flow.</p>
<h4 id="Code-configuration"><a href="#Code-configuration" class="headerlink" title="Code configuration"></a>Code configuration</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    <span class="attr">auth</span>: &#123;</span><br><span class="line">        <span class="comment">// The application ID of your AAD application</span></span><br><span class="line">        <span class="attr">clientId</span>: <span class="string">&quot;11111111-1111-1111-111111111111&quot;</span>,</span><br><span class="line">        <span class="comment">// The authority URL for your application</span></span><br><span class="line">        <span class="attr">authority</span>: <span class="string">&quot;https://login.microsoftonline.com/common&quot;</span>,</span><br><span class="line">        <span class="comment">// Defaults to application start page</span></span><br><span class="line">        <span class="attr">redirectUri</span>: <span class="string">&quot;https://localhost:3000&quot;</span>,</span><br><span class="line">        <span class="attr">postLogoutRedirectUri</span>: <span class="string">&quot;https://localhost:3000/logout&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> loginRequest = &#123;</span><br><span class="line">    <span class="attr">scopes</span>: [<span class="string">`<span class="subst">$&#123;resourceEndpoint&#125;</span>/.default`</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Authority"><a href="#Authority" class="headerlink" title="Authority"></a>Authority</h4><p>The authority is a URL that indicates a directory that MSAL can request tokens from, for more details check the <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-client-application-configuration">MSAL Application configuration options</a>.</p>
<h4 id="Scopes-and-permissions"><a href="#Scopes-and-permissions" class="headerlink" title="Scopes and permissions"></a>Scopes and permissions</h4><p>Applications that integrate with the Microsoft identity platform follow an authorization model that gives users and administrators control over how data can be accessed. <code>/.default</code> represents OpenID Connect scopes, for more details check the <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-permissions-and-consent">Permissions and consent in the Microsoft identity platform</a>.</p>
<h3 id="Sign-in-with-redirect"><a href="#Sign-in-with-redirect" class="headerlink" title="Sign-in with redirect"></a>Sign-in with redirect</h3><p>It’s no need to redirect to sign-in page every time if auth is not expired, just go ahead. You can also <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/scenario-spa-sign-in?tabs=javascript2#sign-in-with-a-pop-up-window">sign-in with a pop-up window</a>.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> username = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> msalInstance = <span class="keyword">new</span> <span class="title class_">PublicClientApplication</span>(config);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleResponse</span>(<span class="params">response</span>) &#123;</span><br><span class="line">    <span class="comment">//handle redirect response</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// In case multiple accounts exist, you can select</span></span><br><span class="line">    <span class="keyword">const</span> currentAccounts = msalInstance.<span class="title function_">getAllAccounts</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentAccounts === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// No accounts detected, need to login</span></span><br><span class="line">        msalInstance.<span class="title function_">loginRedirect</span>(loginRequest);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentAccounts.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// Add choose account code here</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentAccounts.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">        username = currentAccounts[<span class="number">0</span>].<span class="property">username</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">msalInstance.<span class="title function_">handleRedirectPromise</span>().<span class="title function_">then</span>(handleResponse);</span><br></pre></td></tr></table></figure>

<h4 id="Authorization-code"><a href="#Authorization-code" class="headerlink" title="Authorization code"></a>Authorization code</h4><p>After signed in successfully, page will redirect to the redirect URI we set before with the authorization code. MSAL.js library will handle it automatically, we can observe the code on the navigation bar.</p>
<p><img data-src="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6HHQAAAAAAHpK1DZ6S5AguZg?width=1928&height=70" alt="hash-code"></p>
<p>Then the library will parse the authorization code and send the request to get token back directly, all logics encapsulated. Here is the structure of the decoded code.</p>
<p><img data-src="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6JHQAAAAAABGEAriQXq2iNsU?width=1181&height=227" alt="auth-code-deserialized"></p>
<h3 id="Acquire-a-token-with-a-redirect"><a href="#Acquire-a-token-with-a-redirect" class="headerlink" title="Acquire a token with a redirect"></a>Acquire a token with a redirect</h3><p>The pattern for acquiring tokens for APIs with MSAL.js is to first attempt a silent token request by using the <code>acquireTokenSilent</code> method. When this method is called, the library first checks the cache in browser storage to see if a valid token exists and returns it. When no valid token is in the cache, it sends a silent token request to AAD from a hidden iframe.</p>
<p>The silent token requests to AAD might fail for reasons like an expired Azure AD session or a password change. In that case, we need to redirect or using a pop-up window to acquire tokens.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">accessTokenRequest</span>: <span class="title class_">AuthenticationParameters</span> = &#123;</span><br><span class="line">    <span class="attr">scopes</span>: [<span class="string">`<span class="subst">$&#123;resourceEndpoint&#125;</span>/.default`</span>],</span><br><span class="line">    <span class="attr">authority</span>: <span class="variable language_">this</span>.<span class="property">authority</span>,</span><br><span class="line">    <span class="attr">redirectUri</span>: <span class="string">&quot;https://localhost:3000/oauth.html&quot;</span>,</span><br><span class="line">    <span class="attr">account</span>: <span class="variable language_">this</span>.<span class="property">account</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">msalInstance.<span class="title function_">acquireTokenSilent</span>(accessTokenRequest).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">accessTokenResponse</span>) &#123;</span><br><span class="line">    <span class="comment">// Acquire token silent success</span></span><br><span class="line">    <span class="comment">// Call API with token</span></span><br><span class="line">    <span class="keyword">let</span> accessToken = accessTokenResponse.<span class="property">accessToken</span>;</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="comment">//Acquire token silent failure, and send an interactive request</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">errorMessage</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;interaction_required&quot;</span>) !== -<span class="number">1</span>) &#123;</span><br><span class="line">        msalInstance.<span class="title function_">acquireTokenRedirect</span>(accessTokenRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="Why-use-redirect-way"><a href="#Why-use-redirect-way" class="headerlink" title="Why use redirect way?"></a>Why use redirect way?</h4><p>If users have browser constraints or policies where pop-ups windows are disabled, you can use the redirect method. Use the redirect method with the Internet Explorer browser, because there are <a target="_blank" rel="noopener" href="https://github.com/AzureAD/microsoft-authentication-library-for-js/wiki/Known-issues-on-IE-and-Edge-Browser">known issues with pop-up windows on Internet Explorer</a>.</p>
<h3 id="Choice-of-MSAL-js"><a href="#Choice-of-MSAL-js" class="headerlink" title="Choice of MSAL.js"></a>Choice of MSAL.js</h3><p>You will find so many packages when you visit MSAL.js repository, APIs used above should be compatible across the packages, then question comes: how to make a choice?</p>
<p>Besides node package using in the server-side, I recommend <code>msal-browser</code> (<a target="_blank" rel="noopener" href="https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-browser">Microsoft Authentication Library for JavaScript v2.x</a>) or other UI framework wrappers based on it, for its implementation of OAuth 2.0 Authorization Code Flow with PCKE as well as it’s OpenID-compliant.</p>
<p><img data-src="https://1drv.ms/i/c/7a756318060faeec/UQTsrg8GGGN1IIB6InQAAAAAAOR5onzJTSk7gxw?width=1554&height=993" alt="msal-package-structure"></p>
<p>These packages are just official engineering implementations, not so well-documented yet, I had to read the source code for debugging before. Anyway as long as you master the workflow of authentication, it would not be too complicated.</p>
<h2 id="Migration-from-AdalJS-to-MSAL-js"><a href="#Migration-from-AdalJS-to-MSAL-js" class="headerlink" title="Migration from AdalJS to MSAL.js"></a>Migration from AdalJS to MSAL.js</h2><p>AdalJS is the legacy library for AAD authentication used by so many dated products. If you don’t have any idea about this section, the official document explains <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-migration#why-switch-to-msal">Why switch to MSAL</a> clearly.</p>
<h3 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h3><ul>
<li>You may need to change the reply URL type from <code>Web</code> to <code>SPA</code> as MSAL.js required. AdalJS supports both two types, so this change will not block online client services.</li>
<li>Need to specify the <code>accessTokenAcceptedVersion</code> to <code>2</code> and <code>signInAudience</code> to <code>AzureADandPersonalMicrosoftAccount</code> in the manifest if you want to support both AAD account and MSA account. These settings will not break online client services as well.</li>
<li>You can just import the MSAL.js distribution script to your app then test if the current AAD configurations are satisfying both SDKs.</li>
<li>If there is an auth service for the app, you can just do <a target="_blank" rel="noopener" href="https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-browser/docs/login-user.md#silent-login-with-ssosilent">silent login with <code>ssoSlient()</code></a>.</li>
<li>Remember to test all kinds of audiences of the customers and all provided resouce endpoints with access token.</li>
</ul>
<h3 id="Quick-login-verification-on-you-app-page"><a href="#Quick-login-verification-on-you-app-page" class="headerlink" title="Quick login verification on you app page"></a>Quick login verification on you app page</h3><p>PoC (Proof of concept) or verfication always needs quick moves. For the migration scenario, we have to make sure the AAD configurations are correct as well as compatible to make both AdalJS clients and MSAL.js clients login successfully at first stage. To do the quick login verification, the authentication client class need to be exposed to <code>Window</code> global no matter AdalJS or MSAL.js, then we can do experiment on the console of browser.</p>
<h4 id="For-MSAL-js"><a href="#For-MSAL-js" class="headerlink" title="For MSAL.js"></a>For MSAL.js</h4><p>Please refer to the <a target="_blank" rel="noopener" href="https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-browser/docs/initialization.md">document</a>, it’s similar to the codes demonstrated above.</p>
<h4 id="For-AdalJS"><a href="#For-AdalJS" class="headerlink" title="For AdalJS"></a>For AdalJS</h4><p>The docs for AdalJS are much fewer than MSAL.js probably becasue it has been deprecated. And different versions of AdalJS seems to have few subtle API as well as behavior changes, so you may need to update the code below to make it work. My test code is based on AdalJS v1.0.8.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> authContext = <span class="keyword">new</span> <span class="title class_">AuthenticationContext</span>(&#123;</span><br><span class="line">            <span class="attr">instance</span>: <span class="string">&quot;https://login.microsoftonline.com/&quot;</span>,</span><br><span class="line">            <span class="attr">clientId</span>: <span class="string">&quot;Client ID of AAD app&quot;</span>,</span><br><span class="line">            <span class="attr">redirectUri</span>: <span class="string">&quot;Reply URL of AAD app&quot;</span>,</span><br><span class="line">            <span class="attr">postLogoutRedirectUri</span>: <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span>,</span><br><span class="line">            <span class="attr">cacheLocation</span>: <span class="string">&#x27;localStorage&#x27;</span>,</span><br><span class="line">            <span class="attr">endpoints</span>: &#123; <span class="attr">graphApiResourceEndpoint</span>: <span class="string">&quot;https://graph.microsoft.com/&quot;</span> &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Implement the pop-up login flow</span></span><br><span class="line">authContext.<span class="property">config</span>.<span class="property">displayCall</span> = <span class="keyword">function</span> (<span class="params">url</span>) &#123;</span><br><span class="line">      authContext.<span class="property">config</span>.<span class="property">displayCall</span> = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">var</span> popup = <span class="variable language_">window</span>.<span class="title function_">open</span>(url, <span class="string">&#x27;auth-popup&#x27;</span>, <span class="string">&#x27;width=800,height=500&#x27;</span>);</span><br><span class="line">      <span class="keyword">var</span> intervalId = <span class="variable language_">window</span>.<span class="built_in">setInterval</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// Assume your reply URL contains &quot;/signin&quot;</span></span><br><span class="line">          <span class="keyword">if</span> (popup.<span class="property">location</span>.<span class="property">pathname</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;/signin&#x27;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">window</span>.<span class="built_in">clearInterval</span>(intervalId);</span><br><span class="line">            <span class="comment">// Pass the ID token for AdalJS to parse</span></span><br><span class="line">            <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">hash</span> = popup.<span class="property">location</span>.<span class="property">hash</span>;</span><br><span class="line">            <span class="comment">// But AdalJS will not clean the &quot;#&quot; tag in url, so it will redirect in the handleWindowCallback().</span></span><br><span class="line">            <span class="comment">// I&#x27;d like to add a breakpoint inside to update the value of &quot;adal.login.request&quot; key to stop redirection.</span></span><br><span class="line">            <span class="comment">// Just read the source code if you don&#x27;t know what I mean.</span></span><br><span class="line">            authContext.<span class="title function_">handleWindowCallback</span>();</span><br><span class="line">            popup.<span class="title function_">close</span>();</span><br><span class="line">            <span class="keyword">var</span> user = authContext.<span class="title function_">getCachedUser</span>();</span><br><span class="line">            <span class="keyword">if</span> (user) &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user))</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">error</span>(authContext.<span class="title function_">getLoginError</span>());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (whatever) &#123;</span><br><span class="line">          <span class="keyword">if</span> (popup.<span class="property">closed</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(whatever)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="number">100</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Login via a pop-up window</span></span><br><span class="line">authContext.<span class="title function_">login</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Inspect the access token after logining</span></span><br><span class="line">authContext.<span class="title function_">acquireToken</span>(<span class="string">&quot;https://graph.microsoft.com/&quot;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>); <span class="keyword">debugger</span> &#125;)</span><br></pre></td></tr></table></figure>



<h2 id="Frequently-asked-issues"><a href="#Frequently-asked-issues" class="headerlink" title="Frequently asked issues"></a>Frequently asked issues</h2><h3 id="Debugging-and-verification-approach"><a href="#Debugging-and-verification-approach" class="headerlink" title="Debugging and verification approach"></a>Debugging and verification approach</h3><p>You can’t verify your change until the production release, also the change for the production environment can’t be verified on other staging environment since they are using different hosts. So the question is how to debug or do verification?</p>
<p>Basically you can run a local server to host your application with adding a host record which points the production host to your local IP address like <code>127.0.0.1</code> to make it. Remember to enable HTTPS protocol for your local server.</p>
<p>And it’s better to verify your change on both common window and incognito window after the release.</p>
<h3 id="Difference-between-access-token-ID-token-and-refresh-token"><a href="#Difference-between-access-token-ID-token-and-refresh-token" class="headerlink" title="Difference between access token, ID token, and refresh token"></a>Difference between access token, ID token, and refresh token</h3><p>We observed that <code>/oauth2/v2.0/token</code> return 3 tokens: <code>access_token</code>,  <code>id_token</code> and <code>refresh_token</code>.</p>
<p><code>access_token</code> enables clients to securely call protected web APIs, and are used by web APIs to perform authentication and authorization. For more details please check <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/access-tokens">Microsoft identity platform access tokens</a>.</p>
<p><code>id_token</code> should be used to validate that a user is who they claim to be and get additional useful information about them, it can be sent alongside or instead of an access token. We have not used it. For more details please check <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/id-tokens">Microsoft identity platform ID tokens</a>.</p>
<p><code>access_token</code> and <code>id_token</code> are both JWT which consists of a header, payload, and signature portion, that’s why they look so similiar though these two strings are base64 encoded. We mainly use access token for the application, it contains more information than ID token, and we can get user info like name, E-mail from it.</p>
<p>Because access tokens are valid for only a short period of time, authorization servers will sometimes issue a refresh token at the same time the access token is issued. MSAL.js will exchange the <code>refresh_token</code> while request token silently for a new access token when needed.</p>
<h3 id="How-to-change-token-expiration-time"><a href="#How-to-change-token-expiration-time" class="headerlink" title="How to change token expiration time?"></a>How to change token expiration time?</h3><p>Please check this <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/31162257/azure-oauth-how-to-change-token-expiration-time">answer from StackOverflow</a>.</p>
<h3 id="InteractionRequiredAuthError-AADSTS50058-A-silent-sign-in-request-was-sent-but-no-user-is-signed-in"><a href="#InteractionRequiredAuthError-AADSTS50058-A-silent-sign-in-request-was-sent-but-no-user-is-signed-in" class="headerlink" title="InteractionRequiredAuthError: AADSTS50058: A silent sign-in request was sent but no user is signed in."></a>InteractionRequiredAuthError: AADSTS50058: A silent sign-in request was sent but no user is signed in.</h3><p>This error need interaction sign in, thus catch the error and call <code>acquireTokenRedirect</code> method to sign in.</p>
<p>If the error message contains like this “The cookies used to represent the user’s session were not sent in the request to Azure AD. This could happen if the user is using Internet Explorer or Edge, and the web app sending the silent sign-in request is in different IE security zone than the Azure AD endpoint (login.microsoftonline.com).”, upgrade your MSAL.js v1.x to v2.x. Check more details <a target="_blank" rel="noopener" href="https://github.com/AzureAD/microsoft-authentication-library-for-js/issues/1765">here</a>.</p>
<h3 id="The-frame-attempting-navigation-of-the-top-level-window-is-sandboxed-but-the-flag-of-‘allow-top-navigation’-or-‘allow-top-navigation-by-user-activation’-is-not-set"><a href="#The-frame-attempting-navigation-of-the-top-level-window-is-sandboxed-but-the-flag-of-‘allow-top-navigation’-or-‘allow-top-navigation-by-user-activation’-is-not-set" class="headerlink" title="The frame attempting navigation of the top-level window is sandboxed, but the flag of ‘allow-top-navigation’ or ‘allow-top-navigation-by-user-activation’ is not set."></a>The frame attempting navigation of the top-level window is sandboxed, but the flag of ‘allow-top-navigation’ or ‘allow-top-navigation-by-user-activation’ is not set.</h3><p>This error usually occurred while requesting token, mostly it’s caused by wrong reply URL which iframe could not load it to request token silently. So make sure your reply URL pointing to the blank static HTML resource is right. Additional, this error message is somehow confusing cause it does not tell the root cause directly, check more details <a target="_blank" rel="noopener" href="https://github.com/AzureAD/microsoft-authentication-library-for-js/issues/1199">here</a>.</p>
<h3 id="BrowserAuthError-pcke-not-created-The-PCKE-code-challenge-and-verifier-could-not-be-generated"><a href="#BrowserAuthError-pcke-not-created-The-PCKE-code-challenge-and-verifier-could-not-be-generated" class="headerlink" title="BrowserAuthError: pcke_not_created: The PCKE code challenge and verifier could not be generated."></a>BrowserAuthError: pcke_not_created: The PCKE code challenge and verifier could not be generated.</h3><p>Check the protocol and be sure it’s HTTPS.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow">Microsoft identity platform and OAuth 2.0 authorization code flow</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-overview">What is the Microsoft identity platform?</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/auth-oauth2">OAuth 2.0 authentication with Azure Active Directory</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/scenario-spa-sign-in">Single-page application: Sign-in and Sign-out</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/scenario-spa-acquire-token">Single-page application: Acquire a token to call an API</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-client-application-configuration">MSAL Application configuration options</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-permissions-and-consent">Permissions and consent in the Microsoft identity platform</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-configurable-token-lifetimes">Configurable token lifetimes in the Microsoft identity platform</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/id-tokens">Microsoft identity platform ID tokens</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/access-tokens">Microsoft identity platform access tokens</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app">Quickstart: Register an application with the Microsoft identity platform</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/reward-wechat.jpg" alt="John Chou 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/reward-alipay.jpg" alt="John Chou 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>John Chou
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://joouis.com/2021/getting-started-with-aad-integration-in-javascript/" title="Getting started with AAD integration in JavaScript">https://joouis.com/2021/getting-started-with-aad-integration-in-javascript/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nd/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-ND</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/TechTalk/" rel="tag"># TechTalk</a>
              <a href="/tags/oauth/" rel="tag"># oauth</a>
              <a href="/tags/azure/" rel="tag"># azure</a>
              <a href="/tags/aad/" rel="tag"># aad</a>
              <a href="/tags/auth/" rel="tag"># auth</a>
              <a href="/tags/msal/" rel="tag"># msal</a>
              <a href="/tags/microsoft-identity/" rel="tag"># microsoft-identity</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/my-first-step-to-jazz/" rel="prev" title="终于，我迈出了爵士人生的第一步">
                  <i class="fa fa-angle-left"></i> 终于，我迈出了爵士人生的第一步
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/3-idiots-while-driving/" rel="next" title="开车有三宝">
                  开车有三宝 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2016 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Chou</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>



  




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://joouis.com/2021/getting-started-with-aad-integration-in-javascript/"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"joou","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
